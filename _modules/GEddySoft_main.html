

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GEddySoft_main &mdash; GEddySoft 4.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=3304f9e4"></script>
      <script src="../_static/doctools.js?v=9a2dae69"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            GEddySoft
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/performance.html">Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user_guide/running_example.html">Running on Example Dataset</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Project Info</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../version.html">Version History</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Implementation Details</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../theory/software_architecture.html">Software Architecture</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">GEddySoft</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">GEddySoft_main</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for GEddySoft_main</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">GEddySoft: A Python Package for Eddy Covariance Processing</span>

<span class="sd">This module contains the main processing function for the GEddySoft eddy covariance</span>
<span class="sd">software package. It handles the complete workflow of processing raw high-frequency</span>
<span class="sd">data from sonic anemometers and trace gas analyzers (e.g., PTR-TOF-MS) to calculate</span>
<span class="sd">fluxes and quality control metrics.</span>

<span class="sd">Key Features</span>
<span class="sd">------------</span>
<span class="sd">* Flexible input handling for sonic and trace gas data</span>
<span class="sd">* Comprehensive quality control including:</span>

<span class="sd">  * Spike detection (Vickers &amp; Mahrt 1997)</span>
<span class="sd">  * Stationarity tests (Foken &amp; Wichura 1996)</span>
<span class="sd">  * Integral turbulence characteristics (Thomas &amp; Foken 2002)</span>
<span class="sd">  * Instrument diagnostics</span>

<span class="sd">* Advanced processing options:</span>

<span class="sd">  * Multiple coordinate rotation methods</span>
<span class="sd">  * Time lag optimization</span>
<span class="sd">  * Spectral corrections</span>
<span class="sd">  * Flux uncertainty estimation</span>

<span class="sd">* Parallel processing support for large datasets</span>
<span class="sd">* HDF5-based data storage with rich metadata</span>

<span class="sd">Author</span>
<span class="sd">------</span>
<span class="sd">Bernard Heinesch</span>
<span class="sd">University of Li√®ge, Gembloux Agro-Bio Tech</span>

<span class="sd">License</span>
<span class="sd">-------</span>
<span class="sd">GEddySoft is available under the terms of the MIT License.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># %% Package and functions import</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy.signal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">print_progress</span><span class="w"> </span><span class="kn">import</span> <span class="n">print_progress</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">hdfdict</span>  <span class="c1"># not initially available in the anaconda distribution</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>

<span class="c1"># import user functions/modules</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">read_GHG</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_diag_val</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">read_main_inputs</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_main_inputs</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">read_metadata_files</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_metadata_files</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">check_raw_timestamps</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_raw_timestamps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">get_list_input_files</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_list_input_files</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">prepare_output</span><span class="w"> </span><span class="kn">import</span> <span class="n">prepare_output</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">get_closest_value</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_closest_value</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">logBinSpectrum</span><span class="w"> </span><span class="kn">import</span> <span class="n">logBinSpectrum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nanlinfit</span><span class="w"> </span><span class="kn">import</span> <span class="n">nanlinfit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">nandetrend</span><span class="w"> </span><span class="kn">import</span> <span class="n">nandetrend</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">xcov</span><span class="w"> </span><span class="kn">import</span> <span class="n">xcov</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">find_covariance_peak</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_covariance_peak</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">test_steady_state_FW96</span><span class="w"> </span><span class="kn">import</span> <span class="n">test_steady_state_FW96</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">test_steady_state_M98</span><span class="w"> </span><span class="kn">import</span> <span class="n">test_steady_state_M98</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">test_steady_state_D99</span><span class="w"> </span><span class="kn">import</span> <span class="n">test_steady_state_D99</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">test_ITC</span><span class="w"> </span><span class="kn">import</span> <span class="n">test_ITC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">compute_wind_direction</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_wind_direction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cospectrum</span><span class="w"> </span><span class="kn">import</span> <span class="n">cospectrum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">inst_prob_test</span><span class="w"> </span><span class="kn">import</span> <span class="n">inst_prob_test</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">add_attributes</span><span class="w"> </span><span class="kn">import</span> <span class="n">add_attributes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flux_uncertainties</span><span class="w"> </span><span class="kn">import</span> <span class="n">flux_uncertainties</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">clean_results</span><span class="w"> </span><span class="kn">import</span> <span class="n">clean_results</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">correction_factor_lpf</span><span class="w"> </span><span class="kn">import</span> <span class="n">correction_factor_lpf</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">spike_detection_vickers97</span><span class="w"> </span><span class="kn">import</span> <span class="n">spike_detection_vickers97</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">map_sonic2tracer</span><span class="w"> </span><span class="kn">import</span> <span class="n">map_sonic2tracer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wind_rotations</span><span class="w"> </span><span class="kn">import</span> <span class="n">wind_rotations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flux_unit_conversion</span><span class="w"> </span><span class="kn">import</span> <span class="n">flux_unit_conversion</span>

<span class="c1"># %% read inputs and prepare the process of individual days</span>


<div class="viewcode-block" id="GEddySoft_main">
<a class="viewcode-back" href="../api/_autosummary/GEddySoft_main.GEddySoft_main.html#GEddySoft_main.GEddySoft_main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">GEddySoft_main</span><span class="p">(</span><span class="n">str_day</span><span class="p">,</span> <span class="n">ini</span><span class="p">,</span> <span class="n">log_filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process eddy covariance data for a single day (when used in multithread mode)</span>
<span class="sd">    or for the time period given in the ini file.</span>

<span class="sd">    This function handles the complete processing chain for eddy covariance data,</span>
<span class="sd">    from raw high-frequency measurements to quality-controlled fluxes. It supports</span>
<span class="sd">    both single-threaded and parallel processing modes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    str_day : str</span>
<span class="sd">        Date string in format &#39;YYYYMMDD&#39; for the day to process.</span>
<span class="sd">        Use &#39;no_multithread&#39; for single-threaded mode.</span>
<span class="sd">    ini : dict</span>
<span class="sd">        Configuration dictionary containing all processing parameters:</span>

<span class="sd">        * files: Input/output paths and file patterns</span>
<span class="sd">        * param: Processing parameters (QC thresholds, methods, etc.)</span>
<span class="sd">        * run_param: Runtime parameters</span>
<span class="sd">        * sonic: Sonic anemometer configuration</span>
<span class="sd">        * irga: Gas analyzer configuration</span>

<span class="sd">    log_filename : str</span>
<span class="sd">        Path to the log file where processing messages will be written</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    unique_days : list</span>
<span class="sd">        List of successfully processed days</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The processing workflow includes:</span>

<span class="sd">    1. Data loading and synchronization</span>

<span class="sd">       * Sonic anemometer data</span>
<span class="sd">       * Trace gas measurements</span>
<span class="sd">       * Auxiliary meteorological data</span>

<span class="sd">    2. Quality control</span>

<span class="sd">       * Spike detection and removal</span>
<span class="sd">       * Diagnostic value checking</span>
<span class="sd">       * Missing data handling</span>

<span class="sd">    3. Coordinate rotations</span>

<span class="sd">       * Double rotation or</span>
<span class="sd">       * Planar fit method</span>

<span class="sd">    4. Time lag optimization</span>

<span class="sd">       * Covariance maximization</span>
<span class="sd">       * RH-dependent correction</span>

<span class="sd">    5. Flux calculations</span>

<span class="sd">       * Detrending options</span>
<span class="sd">       * Webb-Pearman-Leuning terms</span>

<span class="sd">    6. Quality assessment</span>

<span class="sd">       * Stationarity tests</span>
<span class="sd">       * Integral turbulence characteristics</span>
<span class="sd">       * Spectral analysis</span>

<span class="sd">    7. Uncertainty estimation</span>

<span class="sd">       * Random error (Finkelstein &amp; Sims)</span>
<span class="sd">       * Detection limits</span>

<span class="sd">    The function creates two types of output files:</span>

<span class="sd">    1. Results file (HDF5)</span>

<span class="sd">       * Fluxes and means</span>
<span class="sd">       * Quality flags</span>
<span class="sd">       * Processing parameters</span>

<span class="sd">    2. Covariance file (HDF5, optional)</span>

<span class="sd">       * Raw covariance functions</span>
<span class="sd">       * Time lag information</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; # Process a single day</span>
<span class="sd">    &gt;&gt;&gt; ini = read_main_inputs(&#39;config.txt&#39;)</span>
<span class="sd">    &gt;&gt;&gt; log_file = &#39;processing.log&#39;</span>
<span class="sd">    &gt;&gt;&gt; processed = GEddySoft_main(&#39;20240101&#39;, ini, log_file)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if multi-processing, mute the console and overwrite the file selection of the ini file</span>
    <span class="k">if</span> <span class="n">str_day</span> <span class="o">!=</span> <span class="s1">&#39;no_multithread&#39;</span><span class="p">:</span>
        <span class="c1"># Save the current stdout</span>
        <span class="n">original_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="c1"># Redirect stdout to devnull</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;date_files_selection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;(&#39;</span><span class="si">{}</span><span class="s2">__00_00_00&#39;,&#39;</span><span class="si">{}</span><span class="s2">__23_30_00&#39;)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">str_day</span><span class="p">,</span> <span class="n">str_day</span><span class="p">)</span>

    <span class="c1"># Open logfile in append mode (already opened but see no other solution when multiprocessing)</span>
    <span class="n">OF</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_filename</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>

    <span class="c1"># load metadata files if provided</span>
    <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;meteo_filepath&#39;</span><span class="p">]:</span>
        <span class="n">df_meteofiledata</span> <span class="o">=</span> <span class="n">read_metadata_files</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;meteo_filepath&#39;</span><span class="p">],</span> <span class="n">OF</span><span class="p">,</span> <span class="n">meteo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;TILT_CORRECTION_MODE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">R_tilt_PFM</span> <span class="o">=</span> <span class="n">read_metadata_files</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;tilt_correction_filepath&#39;</span><span class="p">],</span> <span class="n">OF</span><span class="p">,</span> <span class="n">tilt</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;lag_clock_drift_filepath&#39;</span><span class="p">]:</span>
        <span class="c1"># lag drift info are present and must be accounted for</span>
        <span class="n">df_lag_clock_drift</span> <span class="o">=</span> <span class="n">read_metadata_files</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;lag_clock_drift_filepath&#39;</span><span class="p">],</span> <span class="n">OF</span><span class="p">,</span> <span class="n">clock_drift</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_DETECT_METHOD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PRESCRIBED&#39;</span><span class="p">:</span>
        <span class="n">df_lag_prescribed</span> <span class="o">=</span> <span class="n">read_metadata_files</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;lag_prescribed_filepath&#39;</span><span class="p">],</span> <span class="n">OF</span><span class="p">,</span> <span class="n">presc_lag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_RH_DEPENDENCY&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">df_lag_rh_dependency</span> <span class="o">=</span> <span class="n">read_metadata_files</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;lag_rh_dependency_filepath&#39;</span><span class="p">],</span> <span class="n">OF</span><span class="p">,</span> <span class="n">rh_lag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>



    <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LPFC&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">df_lpfc</span> <span class="o">=</span> <span class="n">read_metadata_files</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;lpfc_filepath&#39;</span><span class="p">],</span> <span class="n">OF</span><span class="p">,</span> <span class="n">lpfc</span><span class="o">=</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LPFC&#39;</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">();</span> <span class="n">OF</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># check output folder</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">((</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;output_folder&#39;</span><span class="p">])):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s1">&#39;output folder not found: &#39;</span> <span class="o">+</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;output_folder&#39;</span><span class="p">])</span>
    <span class="c1"># create sub-folder for covariance files if not existing</span>
    <span class="n">cov_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;output_folder&#39;</span><span class="p">],</span> <span class="s1">&#39;cov&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cov_folder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cov_folder</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created missing folder: </span><span class="si">{</span><span class="n">cov_folder</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span> <span class="n">OF</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created missing folder: </span><span class="si">{</span><span class="n">cov_folder</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># get list of sonic and tracer input files (in the given dir for sonic and also in subdir for tracer)</span>
    <span class="n">all_sonic_files_list</span><span class="p">,</span> <span class="n">all_tracer_files_list</span> <span class="o">=</span> <span class="n">get_list_input_files</span><span class="p">(</span><span class="n">ini</span><span class="p">)</span>

    <span class="c1"># map sonic file list to tracer file list if asked for</span>
    <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;MAP_SONIC2TRACER&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;CONCENTRATION_TYPE&#39;</span><span class="p">]:</span>
        <span class="n">all_sonic_files_list</span> <span class="o">=</span> <span class="n">map_sonic2tracer</span><span class="p">(</span><span class="n">all_sonic_files_list</span><span class="p">,</span> <span class="n">all_tracer_files_list</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sonic files mapped to tracer files</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;*************** processing data ***************&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">OF</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;*************** processing data ***************&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># get uniques yyyy_mm_dd in the sonic file list</span>
    <span class="n">unique_days</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;sonic_files_prefix&#39;</span><span class="p">]):</span><span class="nb">len</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;sonic_files_prefix&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">10</span><span class="p">],</span> <span class="n">all_sonic_files_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]))))</span>
    <span class="n">unique_days</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="n">idx_tracers_to_process</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># %% loop on days</span>

    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_days</span><span class="p">)):</span>

        <span class="n">process_irga_data_day</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># select only the given day</span>

        <span class="c1"># for sonic files</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">unique_days</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="ow">in</span> <span class="n">e</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_sonic_files_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">condition</span><span class="p">(</span><span class="n">elem</span><span class="p">)]</span>
        <span class="n">sonic_files_list</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_sonic_files_list</span><span class="p">:</span>
            <span class="n">sonic_files_list</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_sonic_files_list</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;CONCENTRATION_TYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># and for tracer files</span>
            <span class="c1"># Extract year, month, day from the input_date</span>
            <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span> <span class="o">=</span> <span class="n">unique_days</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="c1"># Define a pattern to identify time-related placeholders</span>
            <span class="n">time_placeholders</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;HH|MM|SS&#39;</span><span class="p">)</span>
            <span class="c1"># Remove time-related placeholders from the user_format</span>
            <span class="n">cleaned_format</span> <span class="o">=</span> <span class="n">time_placeholders</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;tracer_files_date_format&#39;</span><span class="p">])</span>
            <span class="c1"># Replace placeholders for date components in the cleaned format</span>
            <span class="n">formatted_date</span> <span class="o">=</span> <span class="n">cleaned_format</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;yyyy&#39;</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;mm&#39;</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;dd&#39;</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
            <span class="c1"># Remove any leftover separators</span>
            <span class="n">formatted_date</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^a-zA-Z0-9]+$&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">formatted_date</span><span class="p">)</span>
    
            <span class="n">condition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">formatted_date</span> <span class="ow">in</span> <span class="n">e</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">elem</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_tracer_files_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">condition</span><span class="p">(</span><span class="n">elem</span><span class="p">)]</span>
    
            <span class="n">tracer_files_list</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;prefix&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">tracer_files_list</span><span class="p">:</span>
                <span class="n">tracer_files_list</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_tracer_files_list</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">]</span>

        <span class="c1"># prepare some variables</span>
        <span class="n">out_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sonic_files_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">upsampling_factor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_SONIC&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_TRACER&#39;</span><span class="p">])</span>

        <span class="c1"># prepare results dict structure</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">prepare_output</span><span class="p">(</span><span class="n">ini</span><span class="p">,</span> <span class="n">out_len</span><span class="p">)</span>

        <span class="c1"># prepare covariance data dict to be stored to file</span>
        <span class="n">cov_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cov&#39;</span><span class="p">:</span> <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_OUTER_WINDOW_SIZE&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">*</span> <span class="n">out_len</span><span class="p">}</span>
        <span class="n">cov_data</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;irga&#39;</span><span class="p">][</span><span class="s1">&#39;irga_columns&#39;</span><span class="p">])))),</span>
                                    <span class="p">[</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;irga&#39;</span><span class="p">][</span><span class="s1">&#39;irga_columns&#39;</span><span class="p">]))]))</span>  <span class="c1"># struct containing results for each tracer</span>

        <span class="c1"># prepare frequency axis for cospectrum</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;WINDOW_LENGTH&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;WINDOW_LENGTH&#39;</span><span class="p">]</span>  <span class="c1"># linear frequency</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">logBinSpectrum</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)),</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;NUM_FREQ_BINS&#39;</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># log-spaced frequency bins</span>

<span class="c1"># %% process sonic data</span>

        <span class="c1"># Loop on sonic files</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sonic_files_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])):</span>

            <span class="c1"># store current time</span>
            <span class="n">proc_start_time_hh</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

            <span class="c1"># load sonic file in sonicdata np</span>
            <span class="n">sonicdata</span><span class="p">,</span> <span class="n">error_code</span> <span class="o">=</span> <span class="n">read_main_inputs</span><span class="p">(</span><span class="n">sonic_files_list</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">],</span> <span class="n">sonic_files_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">],</span> <span class="s1">&#39;sonic&#39;</span><span class="p">,</span> <span class="n">ini</span><span class="p">,</span> <span class="n">OF</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error_code</span><span class="p">:</span> <span class="k">continue</span>

            <span class="c1"># store timestamp</span>
            <span class="c1"># Filename is in UTC+1, start of the half-hour</span>
            <span class="c1"># Timestamp in the input file is in UNIX format (number of seconds since Epoch, 1/1/1970 00:00:00 UTC).</span>
            <span class="c1"># The instruction utcfromtimestamp converts time in the UTC timezone</span>
            <span class="c1"># +3600 : to convert to UTC +1</span>
            <span class="n">first_ts</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">last_ts</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">next</span><span class="p">((</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">last_ts</span> <span class="o">+</span> <span class="mi">3600</span><span class="p">)</span>

            <span class="c1"># remove sonicdata trailing zeros (the file is initially oversized and filled with zero values)</span>
            <span class="n">sonicdata</span> <span class="o">=</span> <span class="n">sonicdata</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[</span><span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]),</span> <span class="p">:]</span>

            <span class="c1"># check completeness of sonic data</span>
            <span class="n">completeness_sonicdata</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]))</span> <span class="o">/</span> \
                                     <span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;WINDOW_LENGTH&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_SONIC&#39;</span><span class="p">])</span>

            <span class="c1"># if sonic file not complete enough, skip this file</span>
            <span class="k">if</span> <span class="n">completeness_sonicdata</span> <span class="o">&lt;</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;COMPLETENESS_THRESHOLD&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sonic file incomplete (&#39;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">completeness_sonicdata</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%), sonic  process skipped&#39;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># reduce sonic file to expected lenght</span>
            <span class="c1"># if the sonic output frequency is slightly higher that it&#39;s nominal one, &quot;trailing&quot; records will be discarded</span>
            <span class="c1"># acceptable only is these nb of records are very limited (e.g. GHS50 files have between 90000 and 90005 records instead of 90000)</span>
            <span class="c1"># the case of the sonic output frequency slightly lower that it&#39;s nominal one is not considered</span>
            <span class="n">sonicdata</span> <span class="o">=</span> <span class="n">sonicdata</span><span class="p">[:</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;WINDOW_LENGTH&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_SONIC&#39;</span><span class="p">],</span> <span class="p">:]</span>

            <span class="c1"># check validity of timestamp series, if present</span>
            <span class="n">time_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">)(</span><span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="mi">3</span><span class="o">/</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_SONIC&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">check_raw_timestamps</span><span class="p">(</span><span class="n">time_series</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sonic file: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="n">OF</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;sonic file: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># check sonic flag and set flagged data to default value</span>
            <span class="c1"># if SPIKE_MODE = 2 and not more than 3 consecutive raw data with error code, then handled by the spike replacement</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: detected sonic data with error code activated&#39;</span><span class="p">)</span>
                <span class="n">sonicdata</span><span class="p">[</span><span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">999</span>

            <span class="c1"># check IRGA flag and set flagged data to NaN</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;CONCENTRATION_TYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;irga&#39;</span><span class="p">][</span><span class="s1">&#39;irga_columns&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">diag_count</span> <span class="o">=</span> <span class="n">read_diag_val</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">8</span><span class="p">])</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">diag_count</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;AGC&#39;</span><span class="p">,</span> <span class="s1">&#39;Sync&#39;</span><span class="p">,</span> <span class="s1">&#39;Aux_input&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;IRGA data flagged&#39;</span><span class="p">)</span>

            <span class="c1"># subsample sonic data from SAMPLING_RATE_SONIC to SAMPLING RATE FINAL if needed</span>
            <span class="c1"># note : InnFlux uses upfirdn routine instead of resample</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_SONIC&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">])):</span>

                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">)):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39; Nans have been detected in this sonic file. Resampling will not work.&#39;</span><span class="p">)</span>  <span class="c1"># debug purposes, see readme for nans and resample</span>

                <span class="n">downsampling_factor</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_SONIC&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">]</span>
                <span class="n">sonicdata</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">downsampling_factor</span><span class="p">))</span>

                <span class="c1"># reconstruct the timestamp colum (used later on by interp1d).</span>
                <span class="c1"># also allows to correct for possible variable transmission delays between the sonic and the final</span>
                <span class="c1"># storage on the datalogger/computer, assuming that the sonic is sending data at a fixed frequency</span>
                <span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">first_ts</span> <span class="o">+</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">))])</span><span class="o">/</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">])</span>  <span class="c1"># first column contains timestamp</span>

            <span class="c1"># detect w and T spikes (and remove if requested)</span>
            <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SPIKE_MODE&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">is_spike</span> <span class="o">=</span> <span class="n">spike_detection_vickers97</span><span class="p">(</span>
                                             <span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span>
                                             <span class="n">spike_mode</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SPIKE_MODE&#39;</span><span class="p">],</span>
                                             <span class="n">avrg_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;WINDOW_LENGTH&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">60</span><span class="p">),</span>
                                             <span class="n">ac_freq</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_SONIC&#39;</span><span class="p">],</span>
                                             <span class="n">spike_limit</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SPIKE_DETECTION_THRESHOLD_W&#39;</span><span class="p">],</span>
                                             <span class="n">max_consec_spikes</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;MAX_CONSEC_SPIKES&#39;</span><span class="p">],</span>
                                             <span class="n">ctrplot</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;PLOT_SPIKE_DETECTION&#39;</span><span class="p">]</span>
                                             <span class="p">)</span>
                <span class="n">num_spikes_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">is_spike</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_spikes_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SPIKE_MODE&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">is_spike</span> <span class="o">=</span> <span class="n">spike_detection_vickers97</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> 
                                             <span class="n">spike_mode</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SPIKE_MODE&#39;</span><span class="p">],</span>
                                             <span class="n">avrg_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;WINDOW_LENGTH&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">60</span><span class="p">),</span>
                                             <span class="n">ac_freq</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_SONIC&#39;</span><span class="p">],</span>
                                             <span class="n">spike_limit</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SPIKE_DETECTION_THRESHOLD_T&#39;</span><span class="p">],</span>
                                             <span class="n">max_consec_spikes</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;MAX_CONSEC_SPIKES&#39;</span><span class="p">],</span>
                                             <span class="n">ctrplot</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;PLOT_SPIKE_DETECTION&#39;</span><span class="p">]</span>
                                             <span class="p">)</span>
                <span class="n">num_spikes_T</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">is_spike</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_spikes_T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="c1"># test on instrument malfunctions from Vitale 2020</span>
            <span class="n">IPT_w</span> <span class="o">=</span> <span class="n">inst_prob_test</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">],</span> <span class="kc">False</span><span class="p">,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">],</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;PLOT_INST_PROB_TEST&#39;</span><span class="p">],</span> <span class="s1">&#39;W&#39;</span><span class="p">)</span>
            <span class="n">IPT_T</span> <span class="o">=</span> <span class="n">inst_prob_test</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;DETREND_TEMPERATURE_SIGNAL&#39;</span><span class="p">],</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">],</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;PLOT_INST_PROB_TEST&#39;</span><span class="p">],</span> <span class="s1">&#39;T_SONIC&#39;</span><span class="p">)</span>

            <span class="c1"># mean and standard deviation of horizontal wind speed and direction</span>
            <span class="c1"># note: wind direction is the angle where the wind is coming from, with north = 0 and east = 90 degrees</span>
            <span class="n">mean_uvw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">mean_wind_speed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_uvw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">mean_uvw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">mean_uvw</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">std_wind_speed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">mean_wind_dir</span> <span class="o">=</span> <span class="n">compute_wind_direction</span><span class="p">(</span><span class="n">mean_uvw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mean_uvw</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SONIC_TYPE&#39;</span><span class="p">],</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SONIC_ORIENTATION&#39;</span><span class="p">])</span>

            <span class="c1"># Compute wind directions using vectorized operations</span>
            <span class="n">wind_directions</span> <span class="o">=</span> <span class="n">compute_wind_direction</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                                                     <span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
                                                     <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SONIC_TYPE&#39;</span><span class="p">],</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SONIC_ORIENTATION&#39;</span><span class="p">])</span>

            <span class="c1"># Compute standard deviation</span>
            <span class="n">std_wind_dir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">wind_directions</span><span class="p">)</span>

            <span class="c1"># Coordinate rotations</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;TILT_CORRECTION_MODE&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">uvw_rot</span><span class="p">,</span> <span class="n">rot_phi</span><span class="p">,</span> <span class="n">R_tilt</span> <span class="o">=</span> <span class="n">wind_rotations</span><span class="p">(</span><span class="n">ini</span><span class="p">,</span> <span class="n">sonicdata</span><span class="p">,</span> <span class="n">mean_uvw</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">uvw_rot</span><span class="p">,</span> <span class="n">rot_phi</span><span class="p">,</span> <span class="n">R_tilt</span> <span class="o">=</span> <span class="n">wind_rotations</span><span class="p">(</span><span class="n">ini</span><span class="p">,</span> <span class="n">sonicdata</span><span class="p">,</span> <span class="n">mean_uvw</span><span class="p">,</span> <span class="n">R_tilt_PFM</span><span class="p">,</span> <span class="n">mean_wind_dir</span><span class="p">)</span>
            <span class="n">mean_uvw_rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">uvw_rot</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># create a common time vector for aligning sonic and irga/tracer data</span>
            <span class="n">interp_time</span> <span class="o">=</span> <span class="n">sonicdata</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;WINDOW_LENGTH&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="o">/</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">]))</span>

            <span class="c1"># interpolate wind and scalar data (keep NaN and extrapolate using NaN)</span>
            <span class="n">interp_u</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">uvw_rot</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)(</span><span class="n">interp_time</span><span class="p">)</span>
            <span class="n">interp_v</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">uvw_rot</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)(</span><span class="n">interp_time</span><span class="p">)</span>
            <span class="n">interp_w</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">uvw_rot</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)(</span><span class="n">interp_time</span><span class="p">)</span>
            <span class="n">interp_Tsonic</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)(</span><span class="n">interp_time</span><span class="p">)</span> <span class="o">+</span> <span class="mf">273.15</span>

            <span class="c1"># check data completeness</span>
            <span class="n">completeness_T</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">interp_Tsonic</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;WINDOW_LENGTH&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">])</span>

            <span class="c1"># Reynolds decomposition of wind components (e.g. u = u_mean + u_prime)</span>
            <span class="n">u_prime</span> <span class="o">=</span> <span class="n">interp_u</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">interp_u</span><span class="p">)</span>
            <span class="n">v_prime</span> <span class="o">=</span> <span class="n">interp_v</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">interp_v</span><span class="p">)</span>
            <span class="n">w_prime</span> <span class="o">=</span> <span class="n">interp_w</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">interp_w</span><span class="p">)</span>

            <span class="c1"># standard deviation of wind</span>
            <span class="n">std_uvw</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">u_prime</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">v_prime</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">w_prime</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>

            <span class="c1"># check for Nans and replace NaN by zero</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">u_prime</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: NaN values detected in u_prime. Replacing with 0.&quot;</span><span class="p">)</span>
                <span class="n">u_prime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">u_prime</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">v_prime</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: NaN values detected in v_prime. Replacing with 0.&quot;</span><span class="p">)</span>
                <span class="n">v_prime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">v_prime</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">w_prime</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: NaN values detected in w_prime. Replacing with 0.&quot;</span><span class="p">)</span>
                <span class="n">w_prime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">w_prime</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># calculate covariances of wind components</span>
            <span class="n">uw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">u_prime</span><span class="p">,</span> <span class="n">w_prime</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">v_prime</span><span class="p">,</span> <span class="n">w_prime</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">uv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">u_prime</span><span class="p">,</span> <span class="n">v_prime</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">uu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">u_prime</span><span class="p">,</span> <span class="n">u_prime</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">v_prime</span><span class="p">,</span> <span class="n">v_prime</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ww</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">w_prime</span><span class="p">,</span> <span class="n">w_prime</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># calculate friction velocity, u*</span>
            <span class="n">u_star</span> <span class="o">=</span> <span class="p">(</span><span class="n">uw</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">vw</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.25</span>

            <span class="c1"># calculate temperature T from virtual sonic temperature T_sonic and water vapor concentration</span>
            <span class="c1"># T_sonic = T*(1 + 0.32*w), were w is the volume mixing ratio of water vapor in air</span>
            <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;CONCENTRATION_TYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                 <span class="n">interp_H2O</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">sonicdata</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)(</span><span class="n">interp_time</span><span class="p">)</span>
                 <span class="n">completeness_H2O</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">interp_H2O</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;WINDOW_LENGTH&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">completeness_H2O</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;CONCENTRATION_TYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">completeness_H2O</span> <span class="o">&gt;=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;COMPLETENESS_THRESHOLD&#39;</span><span class="p">]:</span>

                 <span class="k">if</span> <span class="p">(</span><span class="n">completeness_T</span> <span class="o">&gt;=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;COMPLETENESS_THRESHOLD&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">completeness_H2O</span> <span class="o">&gt;=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;COMPLETENESS_THRESHOLD&#39;</span><span class="p">]):</span>
                    <span class="n">interp_T</span> <span class="o">=</span> <span class="n">interp_Tsonic</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.32</span><span class="o">*</span><span class="mf">1e-3</span><span class="o">*</span><span class="n">interp_H2O</span><span class="p">)</span> <span class="c1"># note that H2O data is given in permille</span>
                    <span class="n">T_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">interp_T</span><span class="p">)</span>
                    <span class="n">dT_dt</span> <span class="o">=</span> <span class="n">nanlinfit</span><span class="p">(</span><span class="n">interp_T</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">dT_dt</span> <span class="o">=</span> <span class="n">dT_dt</span><span class="o">*</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;DETREND_TEMPERATURE_SIGNAL&#39;</span><span class="p">]):</span>
                        <span class="n">T_prime</span> <span class="o">=</span> <span class="n">nandetrend</span><span class="p">(</span><span class="n">interp_T</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">T_prime</span> <span class="o">=</span> <span class="n">interp_T</span> <span class="o">-</span> <span class="n">T_mean</span>
                    <span class="n">std_T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">T_prime</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">T_prime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">T_prime</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># H2O concentration not available, use T_sonic</span>
                <span class="n">interp_T</span> <span class="o">=</span> <span class="n">interp_Tsonic</span>
                <span class="n">T_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">interp_T</span><span class="p">)</span>
                <span class="n">dT_dt</span> <span class="o">=</span> <span class="n">nanlinfit</span><span class="p">(</span><span class="n">interp_T</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dT_dt</span> <span class="o">=</span> <span class="n">dT_dt</span><span class="o">*</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;DETREND_TEMPERATURE_SIGNAL&#39;</span><span class="p">]):</span>
                    <span class="n">T_prime</span> <span class="o">=</span> <span class="n">nandetrend</span><span class="p">(</span><span class="n">interp_T</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">T_prime</span> <span class="o">=</span> <span class="n">interp_T</span> <span class="o">-</span> <span class="n">T_mean</span>
                <span class="n">std_T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">T_prime</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">T_prime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">T_prime</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="c1"># get mean atmospheric pressure</span>
            <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;meteo_filepath&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;meteo&#39;</span><span class="p">][</span><span class="s1">&#39;pressure_column&#39;</span><span class="p">]:</span>
                <span class="n">p_mean</span> <span class="o">=</span> <span class="n">get_closest_value</span><span class="p">(</span><span class="n">df_meteofiledata</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;meteo&#39;</span><span class="p">][</span><span class="s1">&#39;pressure_column&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p_mean</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;DEFAULT_PRESSURE&#39;</span><span class="p">]</span>

            <span class="c1"># get mean air temperature (in K, only for improved computation of air molar concentration)</span>
            <span class="n">T_meteo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;meteo_filepath&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;meteo&#39;</span><span class="p">][</span><span class="s1">&#39;temperature_column&#39;</span><span class="p">]:</span>
                <span class="n">T_meteo</span> <span class="o">=</span> <span class="n">get_closest_value</span><span class="p">(</span><span class="n">df_meteofiledata</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;meteo&#39;</span><span class="p">][</span><span class="s1">&#39;temperature_column&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">])</span> <span class="o">+</span> <span class="mf">273.15</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">T_meteo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

            <span class="c1"># get mean air relative humidity (in %, for lag-RH dependency, if any)</span>
            <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;meteo_filepath&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;meteo&#39;</span><span class="p">][</span><span class="s1">&#39;relative_humidity_column&#39;</span><span class="p">]:</span>
                <span class="n">rh_meteo</span> <span class="o">=</span> <span class="n">get_closest_value</span><span class="p">(</span><span class="n">df_meteofiledata</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;meteo&#39;</span><span class="p">][</span><span class="s1">&#39;relative_humidity_column&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rh_meteo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

            <span class="c1"># calculate air molar concentration (mol m-3)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">T_meteo</span><span class="p">):</span>
                <span class="n">air_mol_conc</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">((</span><span class="n">T_meteo</span><span class="o">/</span><span class="mf">273.15</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1013.25</span><span class="o">/</span><span class="n">p_mean</span><span class="p">)</span> <span class="o">*</span> <span class="mf">22.414e-3</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">air_mol_conc</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">((</span><span class="n">T_mean</span><span class="o">/</span><span class="mf">273.15</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1013.25</span><span class="o">/</span><span class="n">p_mean</span><span class="p">)</span> <span class="o">*</span> <span class="mf">22.414e-3</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="p">(</span><span class="n">completeness_T</span> <span class="o">&gt;=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;COMPLETENESS_THRESHOLD&#39;</span><span class="p">]):</span>

                <span class="c1"># calculate temperature flux &lt;w&#39;T&#39;&gt;</span>
                <span class="n">wT</span> <span class="o">=</span> <span class="n">xcov</span><span class="p">(</span><span class="n">w_prime</span><span class="p">,</span> <span class="n">T_prime</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

                <span class="c1"># calculate spectrum for T</span>
                <span class="p">[</span><span class="n">spec_T</span><span class="p">,</span> <span class="n">spec_T_scaled</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">cospectrum</span><span class="p">(</span><span class="n">ini</span><span class="p">,</span> <span class="n">T_prime</span><span class="p">,</span> <span class="n">T_prime</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">mean_wind_speed</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;PLOT_COSPECTRUM&#39;</span><span class="p">],</span> <span class="n">filename</span><span class="o">=</span><span class="n">sonic_files_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">],</span> <span class="n">spectrum_type</span><span class="o">=</span><span class="s1">&#39;spec&#39;</span><span class="p">)</span>
                <span class="c1"># calculate cospectrum for wT</span>
                <span class="p">[</span><span class="n">cospec_wT</span><span class="p">,</span> <span class="n">cospec_wT_scaled</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">cospectrum</span><span class="p">(</span><span class="n">ini</span><span class="p">,</span> <span class="n">w_prime</span><span class="p">,</span> <span class="n">T_prime</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">mean_wind_speed</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;PLOT_COSPECTRUM&#39;</span><span class="p">],</span> <span class="n">filename</span><span class="o">=</span><span class="n">sonic_files_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">],</span> <span class="n">spectrum_type</span><span class="o">=</span><span class="s1">&#39;cospec&#39;</span><span class="p">)</span>

                <span class="c1"># steady state test for wT according to Foken and Wichura 1996 and to Mahrt 1998</span>
                <span class="n">steady_state_wT_FW96</span> <span class="o">=</span> <span class="n">test_steady_state_FW96</span><span class="p">(</span><span class="n">w_prime</span><span class="p">,</span> <span class="n">T_prime</span><span class="p">)</span>
                <span class="n">steady_state_wT_M98</span> <span class="o">=</span> <span class="n">test_steady_state_M98</span><span class="p">(</span><span class="n">w_prime</span><span class="p">,</span> <span class="n">T_prime</span><span class="p">)</span>
                <span class="n">steady_state_wT_D99</span> <span class="o">=</span> <span class="n">test_steady_state_D99</span><span class="p">(</span><span class="n">w_prime</span><span class="p">,</span> <span class="n">T_prime</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">wT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                <span class="n">spec_T</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">]</span> <span class="o">*</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;NUM_FREQ_BINS&#39;</span><span class="p">]</span>
                <span class="n">spec_T_scaled</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">]</span> <span class="o">*</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;NUM_FREQ_BINS&#39;</span><span class="p">]</span>
                <span class="n">cospec_wT</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">]</span> <span class="o">*</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;NUM_FREQ_BINS&#39;</span><span class="p">]</span>
                <span class="n">cospec_wT_scaled</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">]</span> <span class="o">*</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;NUM_FREQ_BINS&#39;</span><span class="p">]</span>
                <span class="n">steady_state_wT_FW96</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                <span class="n">steady_state_wT_M98</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                <span class="n">steady_state_wT_D99</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

            <span class="c1"># calculate Obukhov length, L</span>
            <span class="n">L</span> <span class="o">=</span> <span class="o">-</span><span class="n">T_mean</span><span class="o">*</span><span class="n">u_star</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="p">(</span><span class="mf">0.4</span><span class="o">*</span><span class="mf">9.81</span><span class="o">*</span><span class="n">wT</span><span class="p">)</span>

            <span class="c1"># calculate stability parameter, z/L</span>
            <span class="n">zoL</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SENSOR_HEIGHT&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">L</span>

            <span class="c1"># calculate potential temperature, theta</span>
            <span class="c1">#           virtual potential temperature, theta_v</span>
            <span class="c1"># and associated wT covariance</span>
            <span class="n">p_0</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># reference pressure for potential temperature [hPa]</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">completeness_T</span> <span class="o">&gt;=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;COMPLETENESS_THRESHOLD&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="n">p_mean</span><span class="p">):</span>
                <span class="n">theta_mean</span> <span class="o">=</span> <span class="n">T_mean</span><span class="o">*</span><span class="p">(</span><span class="n">p_0</span><span class="o">/</span><span class="n">p_mean</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">0.286</span><span class="p">)</span>
                <span class="n">theta_prime</span> <span class="o">=</span> <span class="n">T_prime</span><span class="o">*</span><span class="p">(</span><span class="n">p_0</span><span class="o">/</span><span class="n">p_mean</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">0.286</span><span class="p">)</span>
                <span class="n">wtheta</span> <span class="o">=</span> <span class="n">xcov</span><span class="p">(</span><span class="n">w_prime</span><span class="p">,</span> <span class="n">theta_prime</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">completeness_H2O</span> <span class="o">&gt;=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;COMPLETENESS_THRESHOLD&#39;</span><span class="p">]):</span>
                    <span class="n">theta_v</span> <span class="o">=</span> <span class="n">interp_T</span><span class="o">*</span><span class="p">(</span><span class="n">p_0</span><span class="o">/</span><span class="n">p_mean</span><span class="p">)</span><span class="o">**</span><span class="mf">0.286</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.38</span><span class="o">*</span><span class="mf">1e-3</span><span class="o">*</span><span class="n">interp_H2O</span><span class="p">)</span>  <span class="c1"># note that H2O data is given in permille</span>
                    <span class="n">theta_v_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">theta_v</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;DETREND_TEMPERATURE_SIGNAL&#39;</span><span class="p">]):</span>
                        <span class="n">theta_v_prime</span> <span class="o">=</span> <span class="n">nandetrend</span><span class="p">(</span><span class="n">theta_v</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">theta_v_prime</span> <span class="o">=</span> <span class="n">theta_v</span> <span class="o">-</span> <span class="n">theta_v_mean</span>
                    <span class="n">theta_v_prime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">theta_v_prime</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">wtheta_v</span> <span class="o">=</span> <span class="n">xcov</span><span class="p">(</span><span class="n">w_prime</span><span class="p">,</span> <span class="n">theta_v_prime</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">theta_v_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                    <span class="n">wtheta_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">theta_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                <span class="n">theta_v_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                <span class="n">wtheta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
                <span class="n">wtheta_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

            <span class="c1"># test on developed turbulent conditions</span>
            <span class="n">ITC_w</span><span class="p">,</span> <span class="n">ITC_u</span><span class="p">,</span> <span class="n">ITC_T</span> <span class="o">=</span> <span class="n">test_ITC</span><span class="p">(</span><span class="n">w_prime</span><span class="p">,</span> <span class="n">u_prime</span><span class="p">,</span> <span class="n">T_prime</span><span class="p">,</span> <span class="n">wT</span><span class="p">,</span> <span class="n">zoL</span><span class="p">,</span> <span class="n">u_star</span><span class="p">,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LATITUDE&#39;</span><span class="p">])</span>

            <span class="c1"># store results for sonic data</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;u_unrot&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_uvw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;v_unrot&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_uvw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;w_unrot&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_uvw</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;u_rot&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_uvw_rot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;v_rot&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_uvw_rot</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;w_rot&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_uvw_rot</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;std_u&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_uvw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;std_v&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_uvw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;std_w&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_uvw</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;wsh&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_wind_speed</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;std_wsh&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_wind_speed</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;wdir&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_wind_dir</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;std_wdir&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_wind_dir</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;phi&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">rot_phi</span><span class="o">*</span><span class="mi">180</span><span class="o">/</span><span class="mf">3.1415</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;tilt&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="o">=</span> <span class="n">R_tilt</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;uw&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">uw</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;vw&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">vw</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;uv&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">uv</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;uu&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">uu</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;vv&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">vv</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;ww&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">ww</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;ust&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">u_star</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;T&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_mean</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;std_T&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_T</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;wT&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">wT</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;L&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">L</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;zoL&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">zoL</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;spec_T&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec_T</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;spec_T_scaled&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec_T_scaled</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;cospec_wT&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">cospec_wT</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;cospec_wT_scaled&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">cospec_wT_scaled</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;p&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_mean</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;rho_air_molar&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">air_mol_conc</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;theta&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta_mean</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;theta_v&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta_v_mean</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;wtheta&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">wtheta</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;wtheta_v&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">wtheta_v</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;P_air&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_mean</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;T_air&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_meteo</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;RH_air&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">rh_meteo</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;completeness_sonic&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">completeness_sonicdata</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;num_spikes_w&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_spikes_w</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;num_spikes_T&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_spikes_T</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;SST_wT_FW96&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">steady_state_wT_FW96</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;SST_wT_M98&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">steady_state_wT_M98</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;SST_wT_D99&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">steady_state_wT_D99</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;ITC_w&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">ITC_w</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;ITC_u&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">ITC_u</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;ITC_T&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">ITC_T</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;IPT_w&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPT_w</span>
            <span class="n">results</span><span class="p">[</span><span class="s1">&#39;MET&#39;</span><span class="p">][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;IPT_T&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPT_T</span>

<span class="c1"># %% process IRGA data</span>

            <span class="c1"># IRGA tracers</span>
            <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;CONCENTRATION_TYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                <span class="n">process_irga_data_day</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">lag_clock_drift_samples</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># get clock-drift time lag drift if input file provided</span>
                <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;lag_clock_drift_filepath&#39;</span><span class="p">]:</span>
                    <span class="c1"># time lag drift info are present and must be accounted for</span>
                    <span class="n">lag_clock_drift_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="n">df_lag_clock_drift</span><span class="p">[</span><span class="s1">&#39;TDC-computer&#39;</span><span class="p">][</span><span class="nb">abs</span><span class="p">(</span><span class="n">df_lag_clock_drift</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">])</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span> <span class="o">*</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">])</span>  <span class="c1"># find closest time lag based on timestamp</span>

                <span class="c1"># get prescribed time lag (instrumental + physical) if input file provided</span>
                <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_DETECT_METHOD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PRESCRIBED&#39;</span><span class="p">:</span>
                    <span class="c1"># get prescribed time lag (clock-drift + physical)</span>
                    <span class="n">closest_index</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df_lag_prescribed</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">])</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df_lag_prescribed</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">():</span>
                        <span class="c1"># a lag is present for this half-hour</span>
                        <span class="n">prescribed_lag_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">df_lag_prescribed</span><span class="p">[</span><span class="s1">&#39;time lag in s&#39;</span><span class="p">][</span><span class="n">closest_index</span><span class="p">]</span> <span class="o">*</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">])</span>  <span class="c1"># find closest time lag based on timestamp</span>
                    <span class="k">else</span><span class="p">:</span>                        
                        <span class="c1"># a lag is not present for this half-hour, compute the median lag of the ten closest values</span>
                        <span class="c1"># the median must be computed on the physical lag</span>

                        <span class="c1"># Synchronize on df_lag_prescribed index</span>
                        <span class="n">df_lag_clock_drift_synchronized</span> <span class="o">=</span> <span class="n">df_lag_clock_drift</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df_lag_prescribed</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>

                        <span class="c1"># Calculate indices for the non-NaN values around the gap</span>
                        <span class="n">valid_indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_lag_prescribed</span><span class="p">))</span>
                        <span class="n">valid_distances</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">closest_index</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">valid_indices</span><span class="p">]</span>
                        <span class="n">sorted_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">valid_distances</span><span class="p">,</span> <span class="n">valid_indices</span><span class="p">))]</span>

                        <span class="c1"># Select the closest 10 values for median calculation</span>
                        <span class="n">selected_indices</span> <span class="o">=</span> <span class="n">sorted_indices</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>

                        <span class="c1"># Calculate the median of the selected values</span>
                        <span class="n">prescribed_lag_samples</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">df_lag_prescribed</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">selected_indices</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="n">df_lag_clock_drift_synchronized</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">selected_indices</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="n">df_lag_clock_drift_synchronized</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">closest_index</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">]</span>

                <span class="c1"># compute flux correction factor for low-pass filtering</span>
                <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LPFC&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cf_lpf</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LPFC&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">cf_lpf</span> <span class="o">=</span> <span class="n">correction_factor_lpf</span><span class="p">(</span><span class="n">mean_wind_speed</span><span class="p">,</span> <span class="n">zoL</span><span class="p">,</span> <span class="n">ini</span><span class="p">,</span> <span class="n">df_lpfc</span><span class="o">=</span><span class="n">df_lpfc</span><span class="p">,</span> <span class="n">ctrplot</span><span class="o">=</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;PLOT_CORRECTION_FACTOR_LPF&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LPFC&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">cf_lpf</span> <span class="o">=</span> <span class="n">correction_factor_lpf</span><span class="p">(</span><span class="n">mean_wind_speed</span><span class="p">,</span> <span class="n">zoL</span><span class="p">,</span> <span class="n">ini</span><span class="p">,</span> <span class="n">df_lpfc</span><span class="o">=</span><span class="n">df_lpfc</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="s1">&#39;cf_lpf&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">cf_lpf</span>

                <span class="c1"># loop on concentrations</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;irga&#39;</span><span class="p">][</span><span class="s1">&#39;irga_columns&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>

                    <span class="n">lag_phys_wd_center</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_WINDOW_CENTER&#39;</span><span class="p">]</span>

                    <span class="c1"># replace by the rh-dependent physical lag, if the tracer is present in the rh_dependency file</span>
                    <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_RH_DEPENDENCY&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">searched_mz</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;irga&#39;</span><span class="p">][</span><span class="s1">&#39;irga_names&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">matching_cols</span> <span class="o">=</span> <span class="n">df_lag_rh_dependency</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span>
                            <span class="p">(</span><span class="n">df_lag_rh_dependency</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">searched_mz</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">)</span> <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">df_lag_rh_dependency</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">searched_mz</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span>
                        <span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">matching_cols</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                            <span class="n">closest_index</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df_lag_rh_dependency</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">rh_meteo</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
                            <span class="n">lag_phys_wd_center</span> <span class="o">=</span> <span class="n">df_lag_rh_dependency</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">closest_index</span><span class="p">,</span> <span class="n">matching_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

                    <span class="c1"># detect spikes (and remove if requested)</span>
                    <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SPIKE_MODE&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">sonicdata</span><span class="p">[:,</span> <span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">],</span> <span class="n">is_spike</span><span class="o">=</span><span class="n">spike_detection_vickers97</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[:,</span> <span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">],</span>
                                                     <span class="n">spike_mode</span><span class="o">=</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SPIKE_MODE&#39;</span><span class="p">],</span>
                                                     <span class="n">avrg_len</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;WINDOW_LENGTH&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">60</span><span class="p">),</span>
                                                     <span class="n">ac_freq</span><span class="o">=</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">],</span>
                                                     <span class="n">spike_limit</span><span class="o">=</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SPIKE_DETECTION_THRESHOLD_IRGA&#39;</span><span class="p">],</span>
                                                     <span class="n">max_consec_spikes</span><span class="o">=</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;MAX_CONSEC_SPIKES&#39;</span><span class="p">],</span>
                                                     <span class="n">ctrplot</span><span class="o">=</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;PLOT_SPIKE_DETECTION&#39;</span><span class="p">]</span>
                                                     <span class="p">)</span>
                        <span class="n">num_spikes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">is_spike</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">num_spikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                    <span class="c1"># test on instrument malfunctions from Vitale 2020</span>
                    <span class="n">IPT</span> <span class="o">=</span> <span class="n">inst_prob_test</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[:,</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">],</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;DETREND_TRACER_SIGNAL&#39;</span><span class="p">],</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">],</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;PLOT_INST_PROB_TEST&#39;</span><span class="p">],</span> <span class="s1">&#39;c or h&#39;</span><span class="p">)</span>
                    <span class="c1"># IPT = [np.nan for a in range(12)]</span>
    
                    <span class="n">interp_c</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">sonicdata</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">sonicdata</span><span class="p">[:,</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)(</span><span class="n">interp_time</span><span class="p">)</span>
                    <span class="n">completeness_IRGA</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">interp_c</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;WINDOW_LENGTH&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">completeness_IRGA</span> <span class="o">&gt;=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;COMPLETENESS_THRESHOLD&#39;</span><span class="p">]:</span>

                        <span class="c1"># calculate slope of IRGA tracer signal</span>
                        <span class="n">dc_dt</span> <span class="o">=</span> <span class="n">nanlinfit</span><span class="p">(</span><span class="n">interp_c</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">dc_dt</span> <span class="o">=</span> <span class="n">dc_dt</span><span class="o">*</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">]</span>

                        <span class="c1"># Reynolds decomposition / detrending</span>
                        <span class="n">c_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">interp_c</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;DETREND_TRACER_SIGNAL&#39;</span><span class="p">]):</span>
                            <span class="n">c_prime</span> <span class="o">=</span> <span class="n">nandetrend</span><span class="p">(</span><span class="n">interp_c</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">c_prime</span> <span class="o">=</span> <span class="n">interp_c</span> <span class="o">-</span> <span class="n">c_mean</span>
                        <span class="n">std_c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">c_prime</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">c_prime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">c_prime</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                        <span class="c1"># calculate cross-covariance over a given lag-window</span>
                        <span class="n">cov_wc</span> <span class="o">=</span> <span class="n">xcov</span><span class="p">(</span><span class="n">w_prime</span><span class="p">,</span> <span class="n">c_prime</span><span class="p">,</span> <span class="p">[</span><span class="n">lag_phys_wd_center</span> <span class="o">+</span> <span class="n">lag_clock_drift_samples</span> <span class="o">-</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_OUTER_WINDOW_SIZE&#39;</span><span class="p">],</span> <span class="n">lag_phys_wd_center</span> <span class="o">+</span> <span class="n">lag_clock_drift_samples</span> <span class="o">+</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_OUTER_WINDOW_SIZE&#39;</span><span class="p">]])</span>

                        <span class="c1"># find time lag</span>
                        <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_DETECT_METHOD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CONSTANT&#39;</span><span class="p">:</span>
                            <span class="n">lag_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lag_phys_wd_center</span> <span class="o">+</span> <span class="n">lag_clock_drift_samples</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_DETECT_METHOD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MAX&#39;</span><span class="p">:</span>
                            <span class="n">lag_samples</span> <span class="o">=</span> <span class="n">find_covariance_peak</span><span class="p">(</span><span class="n">cov_wc</span><span class="p">,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_OUTER_WINDOW_SIZE&#39;</span><span class="p">],</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_INNER_WINDOW_SIZE&#39;</span><span class="p">],</span> <span class="n">lag_phys_wd_center</span> <span class="o">+</span> <span class="n">lag_clock_drift_samples</span><span class="p">,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_COVPEAK_FILTER_LENGTH&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;PLOT_FIND_COVARIANCE_PEAK&#39;</span><span class="p">],</span> <span class="n">sonic_files_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">])</span>  <span class="c1"># lag in samples</span>
                        <span class="k">elif</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_DETECT_METHOD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MAX_WITH_DEFAULT&#39;</span><span class="p">:</span>
                            <span class="n">lag_samples</span> <span class="o">=</span> <span class="n">find_covariance_peak</span><span class="p">(</span><span class="n">cov_wc</span><span class="p">,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_OUTER_WINDOW_SIZE&#39;</span><span class="p">],</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_INNER_WINDOW_SIZE&#39;</span><span class="p">],</span> <span class="n">lag_phys_wd_center</span> <span class="o">+</span> <span class="n">lag_clock_drift_samples</span><span class="p">,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_COVPEAK_FILTER_LENGTH&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;PLOT_FIND_COVARIANCE_PEAK&#39;</span><span class="p">],</span> <span class="n">sonic_files_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">])</span>  <span class="c1"># lag in samples</span>
                            <span class="c1"># if lag was found at the extremum of the search window, replace by the default</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">lag_samples</span> <span class="o">==</span> <span class="n">lag_phys_wd_center</span> <span class="o">+</span> <span class="n">lag_clock_drift_samples</span> <span class="o">-</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_INNER_WINDOW_SIZE&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">or</span> 
                                <span class="n">lag_samples</span> <span class="o">==</span> <span class="n">lag_phys_wd_center</span> <span class="o">+</span> <span class="n">lag_clock_drift_samples</span> <span class="o">+</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_INNER_WINDOW_SIZE&#39;</span><span class="p">]):</span>
                                <span class="n">lag_samples</span> <span class="o">=</span> <span class="n">lag_phys_wd_center</span> <span class="o">+</span> <span class="n">lag_clock_drift_samples</span>
                        <span class="k">elif</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_DETECT_METHOD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PRESCRIBED&#39;</span><span class="p">:</span>
                            <span class="n">lag_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">prescribed_lag_samples</span><span class="p">)</span>

                        <span class="n">lagtime_individual</span> <span class="o">=</span> <span class="n">lag_samples</span><span class="o">/</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">]</span>  <span class="c1"># seconds</span>

                        <span class="c1"># calculate flux in umol/m^2/s or mmol/m^2/s</span>
                        <span class="n">flux_individual</span> <span class="o">=</span> <span class="p">(</span><span class="n">cov_wc</span><span class="p">[</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_OUTER_WINDOW_SIZE&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_WINDOW_CENTER&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">lag_clock_drift_samples</span><span class="p">)</span> <span class="o">+</span> <span class="n">lag_samples</span><span class="p">])</span>

                        <span class="c1"># align c_prime for time-lag and trim the circular part, corrected time-series being needed for further computations</span>
                        <span class="k">if</span> <span class="n">lag_samples</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># Shift c_prime forward (to the right), remove front (wrapped)</span>
                            <span class="n">c_prime_trim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">c_prime</span><span class="p">,</span> <span class="n">lag_samples</span><span class="p">)[</span><span class="n">lag_samples</span><span class="p">:]</span>
                            <span class="c1"># Remove first lag_samples from w_prime to align it in time</span>
                            <span class="n">w_prime_trim</span> <span class="o">=</span> <span class="n">w_prime</span><span class="p">[</span><span class="n">lag_samples</span><span class="p">:]</span>
                        <span class="k">elif</span> <span class="n">lag_samples</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">lag_abs</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lag_samples</span><span class="p">)</span>
                            <span class="c1"># Shift c_prime backward (to the left), remove end (wrapped)</span>
                            <span class="n">c_prime_trim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">c_prime</span><span class="p">,</span> <span class="n">lag_samples</span><span class="p">)[:</span><span class="o">-</span><span class="n">lag_abs</span><span class="p">]</span>
                            <span class="c1"># Remove last lag_abs from w_prime to align</span>
                            <span class="n">w_prime_trim</span> <span class="o">=</span> <span class="n">w_prime</span><span class="p">[:</span><span class="o">-</span><span class="n">lag_abs</span><span class="p">]</span>

                        <span class="c1"># calculate spectrum for c and cospectrum for wc</span>
                        <span class="p">[</span><span class="n">spec_c</span><span class="p">,</span> <span class="n">spec_c_scaled</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">cospectrum</span><span class="p">(</span><span class="n">ini</span><span class="p">,</span> <span class="n">c_prime_trim</span><span class="p">,</span> <span class="n">c_prime_trim</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">mean_wind_speed</span><span class="p">,</span> <span class="n">spectrum_type</span><span class="o">=</span><span class="s1">&#39;spec&#39;</span><span class="p">)</span>
                        <span class="p">[</span><span class="n">cospec_wc</span><span class="p">,</span> <span class="n">cospec_wc_scaled</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">cospectrum</span><span class="p">(</span><span class="n">ini</span><span class="p">,</span> <span class="n">w_prime_trim</span><span class="p">,</span> <span class="n">c_prime_trim</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">mean_wind_speed</span><span class="p">,</span> <span class="n">spectrum_type</span><span class="o">=</span><span class="s1">&#39;cospec&#39;</span><span class="p">)</span>

                        <span class="c1"># steady state test according to Foken and Wichura 1996 and to Mahrt 1998</span>
                        <span class="n">steady_state_wc_FW96</span> <span class="o">=</span> <span class="n">test_steady_state_FW96</span><span class="p">(</span><span class="n">w_prime_trim</span><span class="p">,</span> <span class="n">c_prime_trim</span><span class="p">)</span>
                        <span class="n">steady_state_wc_M98</span> <span class="o">=</span> <span class="n">test_steady_state_M98</span><span class="p">(</span><span class="n">w_prime_trim</span><span class="p">,</span> <span class="n">c_prime_trim</span><span class="p">)</span>
                        <span class="n">steady_state_wc_D99</span> <span class="o">=</span> <span class="n">test_steady_state_D99</span><span class="p">(</span><span class="n">w_prime_trim</span><span class="p">,</span> <span class="n">c_prime_trim</span><span class="p">)</span>

                        <span class="c1"># compute flux uncertainties</span>
                        <span class="p">[</span><span class="n">flux_noise_mean</span><span class="p">,</span> <span class="n">flux_noise_std</span><span class="p">,</span> <span class="n">flux_noise_rmse</span><span class="p">,</span> <span class="n">random_error_FS</span><span class="p">,</span> <span class="n">random_flux</span><span class="p">,</span> <span class="n">random_error_noise</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">flux_uncertainties</span><span class="p">(</span><span class="n">ini</span><span class="p">,</span> <span class="n">w_prime_trim</span><span class="p">,</span> <span class="n">c_prime_trim</span><span class="p">)</span>

                        <span class="c1"># convert IRGA flux from kinematic units to desired units</span>
                        <span class="n">flux_individual</span><span class="p">,</span> <span class="n">flux_noise_mean</span><span class="p">,</span> <span class="n">flux_noise_std</span><span class="p">,</span> <span class="n">flux_noise_rmse</span><span class="p">,</span> <span class="n">random_error_FS</span><span class="p">,</span> <span class="n">random_flux</span><span class="p">,</span> <span class="n">random_error_noise</span> <span class="o">=</span> \
                            <span class="n">flux_unit_conversion</span><span class="p">(</span><span class="n">flux_individual</span><span class="p">,</span> <span class="n">flux_noise_mean</span><span class="p">,</span> <span class="n">flux_noise_std</span><span class="p">,</span> <span class="n">flux_noise_rmse</span><span class="p">,</span> <span class="n">random_error_FS</span><span class="p">,</span> <span class="n">random_flux</span><span class="p">,</span> <span class="n">random_error_noise</span><span class="p">,</span> 
                                                 <span class="s1">&#39;to umol m-2 s-1&#39;</span><span class="p">,</span> <span class="n">air_mol_conc</span><span class="p">)</span>

                        <span class="c1"># store results for individual IRGA tracer</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;conc_mean&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_mean</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;conc_std&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_c</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;lagtime&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">lagtime_individual</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;lagtime_clock_drift&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">lag_clock_drift_samples</span><span class="o">/</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">]</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_individual</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;spec&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec_c</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;spec_scaled&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec_c_scaled</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;cospec&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">cospec_wc</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;cospec_scaled&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">cospec_wc_scaled</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;completeness_IRGA&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">completeness_IRGA</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;num_spikes&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_spikes</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;SST_FW96&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">steady_state_wc_FW96</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;SST_M98&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">steady_state_wc_M98</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;SST_D99&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">steady_state_wc_D99</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;IPT&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPT</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;flux_SNR&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">flux_individual</span> <span class="o">-</span> <span class="n">flux_noise_mean</span><span class="p">)</span><span class="o">/</span><span class="n">flux_noise_std</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;flux_noise_mean&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_noise_mean</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;flux_noise_std&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_noise_std</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;flux_noise_rmse&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_noise_rmse</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;random_error_FS&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_error_FS</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;random_flux&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_flux</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;random_error_noise&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_error_noise</span>
                        <span class="n">cov_data</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;cov&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov_wc</span>


<span class="c1"># %% process TRACER data</span>

            <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;CONCENTRATION_TYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># load corresponding tracer file</span>
                <span class="n">tracerdata</span><span class="p">,</span> <span class="n">error_code</span><span class="p">,</span> <span class="n">idx_tracers_to_process</span><span class="p">,</span> <span class="n">tracer_file_index</span><span class="p">,</span> <span class="o">*</span><span class="n">rest</span> <span class="o">=</span> <span class="n">read_main_inputs</span><span class="p">(</span><span class="n">sonic_files_list</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">],</span> <span class="n">sonic_files_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">],</span> <span class="s1">&#39;tracer&#39;</span><span class="p">,</span> <span class="n">ini</span><span class="p">,</span> <span class="n">OF</span><span class="p">,</span> <span class="n">idx_tracers_to_process</span><span class="p">,</span> <span class="n">tracer_files_list</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">cov_data</span><span class="p">,</span> <span class="n">out_len</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rest</span><span class="p">:</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">cov_data</span> <span class="o">=</span> <span class="n">rest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
                <span class="c1"># process tracer data</span>
                <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">error_code</span><span class="p">):</span>  <span class="c1"># corresponding tracer file was found</span>
                
                    <span class="c1"># compute completeness of tracer data</span>
                    <span class="n">completeness_tracerdata</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc&#39;</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;WINDOW_LENGTH&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">])</span>
    
                    <span class="c1"># check validity of timestamp series, if present</span>
                    <span class="n">time_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">)(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]))</span>
                    <span class="n">threshold</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="mi">2</span><span class="o">/</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_TRACER&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">check_raw_timestamps</span><span class="p">(</span><span class="n">time_series</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;tracer file: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="n">OF</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;tracer file: &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    
                    <span class="c1"># # debug, check for time differences between sonic and tracer timestamps</span>
                    <span class="c1"># if completeness_tracerdata[0] &gt; ini[&#39;param&#39;][&#39;COMPLETENESS_THRESHOLD&#39;]:</span>
                    <span class="c1">#     soniclen=len(sonicdata[:,0])</span>
                    <span class="c1">#     tracerlen=len(tracerdata[&#39;time&#39;])</span>
                    <span class="c1">#     timedif = sonicdata[0:min(soniclen,tracerlen),0] - tracerdata[&#39;time&#39;][0:min(soniclen,tracerlen)]</span>
                    <span class="c1">#     if abs(max(timedif)) &gt; 0.1:</span>
                    <span class="c1">#         import matplotlib.pyplot as plt</span>
                    <span class="c1">#         plt.plot(timedif)</span>
                    <span class="c1">#         print(&#39;timedif detected for file : &#39; + sonic_files_list[&#39;name&#39;][n] )  # + &#39;\n&#39;</span>

                    <span class="c1"># upsample data to final sampling rate if necessary</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_TRACER&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">]):</span>
                        <span class="n">first_ts</span> <span class="o">=</span> <span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

                        <span class="n">upsampling_factor</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_TRACER&#39;</span><span class="p">]</span>
                        <span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">upsampling_factor</span><span class="p">))</span>

                        <span class="c1"># reconstruct the timestamp colum (used later on by interp1d). </span>
                        <span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">first_ts</span> <span class="o">+</span>
                                                 <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]))])</span><span class="o">/</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">])</span>

                    <span class="n">lag_clock_drift_samples</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="c1"># get clock-drift time lag drift if input file provided</span>
                    <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;lag_clock_drift_filepath&#39;</span><span class="p">]:</span>
                        <span class="c1"># time lag drift info are present and must be accounted for</span>
                        <span class="n">lag_clock_drift_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="o">-</span><span class="n">df_lag_clock_drift</span><span class="p">[</span><span class="s1">&#39;TDC-computer&#39;</span><span class="p">][</span><span class="nb">abs</span><span class="p">(</span><span class="n">df_lag_clock_drift</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">])</span><span class="o">.</span><span class="n">argmin</span><span class="p">()]</span> <span class="o">*</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">])</span>  <span class="c1"># find closest time lag based on timestamp</span>

                    <span class="c1"># get prescribed time lag (instrumental + physical) if input file provided</span>
                    <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_DETECT_METHOD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PRESCRIBED&#39;</span><span class="p">:</span>

                        <span class="n">closest_index</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df_lag_prescribed</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">])</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df_lag_prescribed</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">])</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">==</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">():</span>
                            <span class="c1"># a lag is present for this half-hour</span>
                            <span class="n">prescribed_lag_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">df_lag_prescribed</span><span class="p">[</span><span class="s1">&#39;time lag in s&#39;</span><span class="p">][</span><span class="n">closest_index</span><span class="p">]</span> <span class="o">*</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">])</span>  <span class="c1"># find closest time lag based on timestamp</span>
                        <span class="k">else</span><span class="p">:</span>                 
                            <span class="c1"># a lag is not present for this half-hour, compute the median lag of the ten closest values</span>
                            <span class="c1"># the median must be computed on the physical lag</span>

                            <span class="c1"># Synchronize on df_lag_prescribed index</span>
                            <span class="n">df_lag_clock_drift_synchronized</span> <span class="o">=</span> <span class="n">df_lag_clock_drift</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">df_lag_prescribed</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>

                            <span class="c1"># Calculate indices for the non-NaN values around the gap</span>
                            <span class="n">valid_indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_lag_prescribed</span><span class="p">))</span>
                            <span class="n">valid_distances</span> <span class="o">=</span> <span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">closest_index</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">valid_indices</span><span class="p">]</span>
                            <span class="n">sorted_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">valid_distances</span><span class="p">,</span> <span class="n">valid_indices</span><span class="p">))]</span>

                            <span class="c1"># Select the closest 10 values for median calculation</span>
                            <span class="n">selected_indices</span> <span class="o">=</span> <span class="n">sorted_indices</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>

                            <span class="c1"># Calculate the median of the selected values</span>
                            <span class="n">prescribed_lag_samples</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">df_lag_prescribed</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">selected_indices</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="n">df_lag_clock_drift_synchronized</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">selected_indices</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="n">df_lag_clock_drift_synchronized</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">closest_index</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">]</span>

                    <span class="c1"># compute flux correction factor for low-pass filtering</span>
                    <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LPFC&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">cf_lpf</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">elif</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LPFC&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">cf_lpf</span> <span class="o">=</span> <span class="n">correction_factor_lpf</span><span class="p">(</span><span class="n">mean_wind_speed</span><span class="p">,</span> <span class="n">zoL</span><span class="p">,</span> <span class="n">ini</span><span class="p">,</span> <span class="n">df_lpfc</span><span class="o">=</span><span class="n">df_lpfc</span><span class="p">,</span> <span class="n">ctrplot</span><span class="o">=</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;PLOT_CORRECTION_FACTOR_LPF&#39;</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LPFC&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">cf_lpf</span> <span class="o">=</span> <span class="n">correction_factor_lpf</span><span class="p">(</span><span class="n">mean_wind_speed</span><span class="p">,</span> <span class="n">zoL</span><span class="p">,</span> <span class="n">ini</span><span class="p">,</span> <span class="n">df_lpfc</span><span class="o">=</span><span class="n">df_lpfc</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="s1">&#39;cf_lpf&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">cf_lpf</span>

                    <span class="c1"># save config parameters</span>
                    <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="s1">&#39;default_CC_kinetic&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;default_CC_kinetic&#39;</span><span class="p">]</span>

                    <span class="c1"># iterate over tracers</span>
                    <span class="n">msg_tracer</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>

                        <span class="c1"># check if whole values are NaNs and skip process if the case</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">])):</span>
                            <span class="n">msg_tracer</span> <span class="o">=</span> <span class="n">msg_tracer</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Warning: full NaN values found in tracerdata[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="n">OF</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Warning: full NaN values found in tracerdata[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">))</span>
                            <span class="k">continue</span>
    
                        <span class="c1"># check for NaNs, send a warning if present and skip process if the case</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">])):</span>
                            <span class="n">msg_tracer</span> <span class="o">=</span> <span class="n">msg_tracer</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;Warning: NaN values found in tracerdata[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="n">OF</span><span class="o">.</span><span class="n">write</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;Warning: NaN values found in tracerdata[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>
                            <span class="k">continue</span>

                        <span class="c1"># check completeness of tracer data</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">completeness_tracerdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;COMPLETENESS_THRESHOLD&#39;</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">msg_tracer</span> <span class="o">=</span> <span class="n">msg_tracer</span> <span class="o">+</span> <span class="s1">&#39;tracer file incomplete (&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">completeness_tracerdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;%), tracer process skipped</span><span class="se">\n</span><span class="s1">&#39;</span>
                                <span class="k">continue</span>

                        <span class="n">lag_phys_wd_center</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_WINDOW_CENTER&#39;</span><span class="p">]</span>

                        <span class="c1"># replace by the rh-dependent physical lag, if the tracer is present in the rh_dependency file</span>
                        <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_RH_DEPENDENCY&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">searched_mz</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span> <span class="mi">3</span><span class="p">)</span>
                            <span class="n">matching_cols</span> <span class="o">=</span> <span class="n">df_lag_rh_dependency</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span>
                                <span class="p">(</span><span class="n">df_lag_rh_dependency</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">searched_mz</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">)</span> <span class="o">&amp;</span>
                                <span class="p">(</span><span class="n">df_lag_rh_dependency</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">searched_mz</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span>
                            <span class="p">]</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">matching_cols</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                                <span class="n">closest_index</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df_lag_rh_dependency</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">rh_meteo</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
                                <span class="n">lag_phys_wd_center</span> <span class="o">=</span> <span class="n">df_lag_rh_dependency</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">closest_index</span><span class="p">,</span> <span class="n">matching_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
  
                        <span class="c1"># statistics on tracer signal and zero</span>
                        <span class="n">c_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">])</span>
                        <span class="n">c_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">])</span>
                        <span class="n">c_Q5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>
                        <span class="n">c_Q95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">],</span> <span class="mi">95</span><span class="p">)</span>
                        <span class="n">c_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc_acc&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]))</span>
                        <span class="n">c_prec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc_prec&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc_prec&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">])))</span>
                        <span class="n">c_LOD</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;zero_prec&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;zero_prec&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">])))</span>

                        <span class="c1"># detect spikes (and remove if requested)</span>
                        <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SPIKE_MODE&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">is_spike</span> <span class="o">=</span> <span class="n">spike_detection_vickers97</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">],</span> 
                                                  <span class="n">spike_mode</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SPIKE_MODE&#39;</span><span class="p">],</span>
                                                  <span class="n">avrg_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;WINDOW_LENGTH&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">60</span><span class="p">),</span>
                                                  <span class="n">ac_freq</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">],</span>
                                                  <span class="n">spike_limit</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SPIKE_DETECTION_THRESHOLD_TRACER&#39;</span><span class="p">],</span>
                                                  <span class="n">max_consec_spikes</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;MAX_CONSEC_SPIKES&#39;</span><span class="p">],</span>
                                                  <span class="n">ctrplot</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;PLOT_SPIKE_DETECTION&#39;</span><span class="p">]</span>
                                                  <span class="p">)</span>
                            <span class="n">num_spikes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">is_spike</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">num_spikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                        <span class="c1"># test on instrument malfunctions from Vitale 2020</span>
                        <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;PROCESS_IPT_TRACERS&#39;</span><span class="p">]:</span>
                            <span class="n">IPT</span> <span class="o">=</span> <span class="n">inst_prob_test</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;DETREND_TRACER_SIGNAL&#39;</span><span class="p">],</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">],</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;PLOT_INST_PROB_TEST&#39;</span><span class="p">],</span> <span class="s1">&#39;tracer&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">IPT</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)]</span>

                        <span class="c1"># caclulate slope of tracer signal</span>
                        <span class="n">dc_dt</span> <span class="o">=</span> <span class="n">nanlinfit</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">dc_dt</span> <span class="o">=</span> <span class="n">dc_dt</span><span class="o">*</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_TRACER&#39;</span><span class="p">]</span>

                        <span class="c1"># interpolate concentration data (keep NaNs and extrapolate using NaNs)</span>
                        <span class="n">interp_c</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][:]),</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc&#39;</span><span class="p">][:,</span> <span class="n">i</span><span class="p">]),</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)(</span><span class="n">interp_time</span><span class="p">)</span>

                        <span class="c1"># Reynolds decomposition / detrending</span>
                        <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;DETREND_TRACER_SIGNAL&#39;</span><span class="p">]:</span>
                            <span class="n">c_prime</span> <span class="o">=</span> <span class="n">nandetrend</span><span class="p">(</span><span class="n">interp_c</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">c_prime</span> <span class="o">=</span> <span class="n">interp_c</span> <span class="o">-</span> <span class="n">c_mean</span>

                        <span class="c1"># trim w_prime and c_prime for NaNs, keeping the alignment</span>
                        <span class="n">first</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">w_prime</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">w_prime</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">w_prime</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">w_prime_trim</span> <span class="o">=</span> <span class="n">w_prime</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span> <span class="n">c_prime_trim</span> <span class="o">=</span> <span class="n">c_prime</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">first</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">c_prime_trim</span><span class="p">)),</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_prime_trim</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">c_prime_trim</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">w_prime_trim</span> <span class="o">=</span> <span class="n">w_prime_trim</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span> <span class="n">c_prime_trim</span> <span class="o">=</span> <span class="n">c_prime_trim</span><span class="p">[</span><span class="n">first</span><span class="p">:</span><span class="n">last</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

                        <span class="c1"># calculate cross-covariance over a given lag-window</span>
                        <span class="n">cov_wc</span> <span class="o">=</span> <span class="n">xcov</span><span class="p">(</span><span class="n">w_prime_trim</span><span class="p">,</span> <span class="n">c_prime_trim</span><span class="p">,</span> <span class="p">[</span><span class="n">lag_phys_wd_center</span> <span class="o">+</span> <span class="n">lag_clock_drift_samples</span> <span class="o">-</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_OUTER_WINDOW_SIZE&#39;</span><span class="p">],</span> <span class="n">lag_phys_wd_center</span> <span class="o">+</span> <span class="n">lag_clock_drift_samples</span> <span class="o">+</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_OUTER_WINDOW_SIZE&#39;</span><span class="p">]])</span>

                        <span class="c1"># find time lag</span>
                        <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_DETECT_METHOD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CONSTANT&#39;</span><span class="p">:</span>
                            <span class="n">lag_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lag_phys_wd_center</span> <span class="o">+</span> <span class="n">lag_clock_drift_samples</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_DETECT_METHOD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MAX&#39;</span><span class="p">:</span>
                            <span class="n">lag_samples</span> <span class="o">=</span> <span class="n">find_covariance_peak</span><span class="p">(</span><span class="n">cov_wc</span><span class="p">,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_OUTER_WINDOW_SIZE&#39;</span><span class="p">],</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_INNER_WINDOW_SIZE&#39;</span><span class="p">],</span> <span class="n">lag_phys_wd_center</span> <span class="o">+</span> <span class="n">lag_clock_drift_samples</span><span class="p">,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_COVPEAK_FILTER_LENGTH&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;PLOT_FIND_COVARIANCE_PEAK&#39;</span><span class="p">],</span> <span class="n">tracer_files_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="n">tracer_file_index</span><span class="p">])</span>  <span class="c1"># lag in samples</span>
                        <span class="k">elif</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_DETECT_METHOD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;MAX_WITH_DEFAULT&#39;</span><span class="p">:</span>
                            <span class="n">lag_samples</span> <span class="o">=</span> <span class="n">find_covariance_peak</span><span class="p">(</span><span class="n">cov_wc</span><span class="p">,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_OUTER_WINDOW_SIZE&#39;</span><span class="p">],</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_INNER_WINDOW_SIZE&#39;</span><span class="p">],</span> <span class="n">lag_phys_wd_center</span> <span class="o">+</span> <span class="n">lag_clock_drift_samples</span><span class="p">,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_COVPEAK_FILTER_LENGTH&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;PLOT_FIND_COVARIANCE_PEAK&#39;</span><span class="p">],</span> <span class="n">tracer_files_list</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="n">tracer_file_index</span><span class="p">])</span>  <span class="c1"># lag in samples</span>
                            <span class="c1"># if lag was found at the extremum of the search window, replace by the default</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">lag_samples</span> <span class="o">==</span> <span class="n">lag_phys_wd_center</span> <span class="o">+</span> <span class="n">lag_clock_drift_samples</span> <span class="o">-</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_INNER_WINDOW_SIZE&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="ow">or</span> 
                                <span class="n">lag_samples</span> <span class="o">==</span> <span class="n">lag_phys_wd_center</span> <span class="o">+</span> <span class="n">lag_clock_drift_samples</span> <span class="o">+</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_INNER_WINDOW_SIZE&#39;</span><span class="p">]):</span>
                                <span class="n">lag_samples</span> <span class="o">=</span> <span class="n">lag_phys_wd_center</span> <span class="o">+</span> <span class="n">lag_clock_drift_samples</span>
                        <span class="k">elif</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_DETECT_METHOD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;PRESCRIBED&#39;</span><span class="p">:</span>
                            <span class="n">lag_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">prescribed_lag_samples</span><span class="p">)</span>

                        <span class="n">lagtime_individual</span> <span class="o">=</span> <span class="n">lag_samples</span><span class="o">/</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">]</span>  <span class="c1"># seconds</span>

                        <span class="c1"># calculate flux in ug/m^2/s</span>
                        <span class="n">flux_individual</span> <span class="o">=</span> <span class="n">cov_wc</span><span class="p">[</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;LAG_OUTER_WINDOW_SIZE&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">lag_phys_wd_center</span> <span class="o">+</span> <span class="n">lag_clock_drift_samples</span><span class="p">)</span> <span class="o">+</span> <span class="n">lag_samples</span><span class="p">]</span>

                        <span class="c1"># correct flux for low-pass filtering</span>
                        <span class="n">flux_individual</span> <span class="o">=</span> <span class="n">flux_individual</span> <span class="o">*</span> <span class="n">cf_lpf</span>

                        <span class="c1"># align c_prime for time-lag and trim the circular part, corrected time-series being needed for further computations</span>
                        <span class="k">if</span> <span class="n">lag_samples</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># Shift c_prime forward (to the right), remove front (wrapped)</span>
                            <span class="n">c_prime_trim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">c_prime_trim</span><span class="p">,</span> <span class="n">lag_samples</span><span class="p">)[</span><span class="n">lag_samples</span><span class="p">:]</span>
                            <span class="c1"># Remove first lag_samples from w_prime to align it in time</span>
                            <span class="n">w_prime_trim</span> <span class="o">=</span> <span class="n">w_prime_trim</span><span class="p">[</span><span class="n">lag_samples</span><span class="p">:]</span>
                        <span class="k">elif</span> <span class="n">lag_samples</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">lag_abs</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lag_samples</span><span class="p">)</span>
                            <span class="c1"># Shift c_prime backward (to the left), remove end (wrapped)</span>
                            <span class="n">c_prime_trim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">c_prime_trim</span><span class="p">,</span> <span class="n">lag_samples</span><span class="p">)[:</span><span class="o">-</span><span class="n">lag_abs</span><span class="p">]</span>
                            <span class="c1"># Remove last lag_abs from w_prime to align</span>
                            <span class="n">w_prime_trim</span> <span class="o">=</span> <span class="n">w_prime_trim</span><span class="p">[:</span><span class="o">-</span><span class="n">lag_abs</span><span class="p">]</span>

                        <span class="c1"># calculate spectrum for c and cospectrum for wc</span>
                        <span class="p">[</span><span class="n">spec_c</span><span class="p">,</span> <span class="n">spec_c_scaled</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">cospectrum</span><span class="p">(</span><span class="n">ini</span><span class="p">,</span> <span class="n">c_prime_trim</span><span class="p">,</span> <span class="n">c_prime_trim</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">mean_wind_speed</span><span class="p">,</span> <span class="n">spectrum_type</span><span class="o">=</span><span class="s1">&#39;spec&#39;</span><span class="p">)</span>
                        <span class="p">[</span><span class="n">cospec_wc</span><span class="p">,</span> <span class="n">cospec_wc_scaled</span><span class="p">,</span> <span class="n">_</span><span class="p">]</span> <span class="o">=</span> <span class="n">cospectrum</span><span class="p">(</span><span class="n">ini</span><span class="p">,</span> <span class="n">w_prime_trim</span><span class="p">,</span> <span class="n">c_prime_trim</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">mean_wind_speed</span><span class="p">,</span> <span class="n">spectrum_type</span><span class="o">=</span><span class="s1">&#39;cospec&#39;</span><span class="p">)</span>

                        <span class="c1"># steady state test according to Foken and Wichura 1996 and to Mahrt 1998</span>
                        <span class="n">steady_state_wc_FW96</span> <span class="o">=</span> <span class="n">test_steady_state_FW96</span><span class="p">(</span><span class="n">w_prime_trim</span><span class="p">,</span> <span class="n">c_prime_trim</span><span class="p">)</span>
                        <span class="n">steady_state_wc_M98</span> <span class="o">=</span> <span class="n">test_steady_state_M98</span><span class="p">(</span><span class="n">w_prime_trim</span><span class="p">,</span> <span class="n">c_prime_trim</span><span class="p">)</span>
                        <span class="n">steady_state_wc_D99</span> <span class="o">=</span> <span class="n">test_steady_state_D99</span><span class="p">(</span><span class="n">w_prime_trim</span><span class="p">,</span> <span class="n">c_prime_trim</span><span class="p">)</span>

                        <span class="c1"># compute flux uncertainties</span>
                        <span class="p">[</span><span class="n">flux_noise_mean</span><span class="p">,</span> <span class="n">flux_noise_std</span><span class="p">,</span> <span class="n">flux_noise_rmse</span><span class="p">,</span> <span class="n">random_error_FS</span><span class="p">,</span> <span class="n">random_flux</span><span class="p">,</span> <span class="n">random_error_noise</span><span class="p">]</span> <span class="o">=</span> \
                            <span class="n">flux_uncertainties</span><span class="p">(</span><span class="n">ini</span><span class="p">,</span> <span class="n">w_prime_trim</span><span class="p">,</span> <span class="n">c_prime_trim</span><span class="p">)</span>

                        <span class="c1"># convert tracer flux and associated variables from kinematic units to desired units</span>
                        <span class="n">flux_individual</span><span class="p">,</span> <span class="n">flux_noise_mean</span><span class="p">,</span> <span class="n">flux_noise_std</span><span class="p">,</span> <span class="n">flux_noise_rmse</span><span class="p">,</span> <span class="n">random_error_FS</span><span class="p">,</span> <span class="n">random_flux</span><span class="p">,</span> <span class="n">random_error_noise</span> <span class="o">=</span> \
                            <span class="n">flux_unit_conversion</span><span class="p">(</span><span class="n">flux_individual</span><span class="p">,</span> <span class="n">flux_noise_mean</span><span class="p">,</span> <span class="n">flux_noise_std</span><span class="p">,</span> <span class="n">flux_noise_rmse</span><span class="p">,</span> <span class="n">random_error_FS</span><span class="p">,</span> <span class="n">random_flux</span><span class="p">,</span> <span class="n">random_error_noise</span><span class="p">,</span> 
                                                 <span class="s1">&#39;to ug m-2 s-1&#39;</span><span class="p">,</span> <span class="n">air_mol_conc</span><span class="p">,</span> <span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

                        <span class="c1"># store results for individual tracer</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;conc_mean&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_mean</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;conc_std&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_std</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;conc_Q5&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_Q5</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;conc_Q95&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_Q95</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;conc_acc&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_acc</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;conc_prec&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_prec</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;conc_LOD&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_LOD</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;lagtime&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">lagtime_individual</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;lagtime_clock_drift&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">lag_clock_drift_samples</span><span class="o">/</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">][</span><span class="s1">&#39;SAMPLING_RATE_FINAL&#39;</span><span class="p">]</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_individual</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;spec&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec_c</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;spec_scaled&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec_c_scaled</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;cospec&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">cospec_wc</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;cospec_scaled&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">cospec_wc_scaled</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;completeness_TRACER&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">completeness_tracerdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;num_spikes&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_spikes</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;SST_FW96&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">steady_state_wc_FW96</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;SST_M98&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">steady_state_wc_M98</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;SST_D99&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">steady_state_wc_D99</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;IPT&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">IPT</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;flux_SNR&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">flux_individual</span> <span class="o">-</span> <span class="n">flux_noise_mean</span><span class="p">)</span><span class="o">/</span><span class="n">flux_noise_std</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;flux_noise_mean&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_noise_mean</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;flux_noise_std&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_noise_std</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;flux_noise_rmse&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux_noise_rmse</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;random_error_FS&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_error_FS</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;random_flux&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_flux</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;qaqc&#39;</span><span class="p">][</span><span class="s1">&#39;random_error_noise&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_error_noise</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;calibration&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;calibration&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;transmission&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;transmission&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;Xr0&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;Xr0&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;cluster_min&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;cluster_min&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;cluster_max&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;cluster_max&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;k_reac&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;k_reac&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;FY&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;FY&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;IF&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;IF&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

                        <span class="n">cov_data</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;cov&#39;</span><span class="p">][</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov_wc</span>

                        <span class="n">print_progress</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">tracerdata</span><span class="p">[</span><span class="s1">&#39;conc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;tracers processed&#39;</span><span class="p">,</span> <span class="n">flush_</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">end_</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

                    <span class="c1"># display time needed</span>
                    <span class="n">proc_end_time_hh</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;process time: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">((</span><span class="n">proc_end_time_hh</span> <span class="o">-</span> <span class="n">proc_start_time_hh</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">);</span> <span class="n">OF</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># display messages</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg_tracer</span><span class="p">)</span>

        <span class="c1"># %% clean results for unprocessed sonic files</span>
        <span class="n">clean_results</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># %% output data</span>

        <span class="c1"># save covariance functions to file</span>
        <span class="c1"># if (tracer_files_list or ini[&#39;irga&#39;][&#39;irga_columns&#39;]) and ini[&#39;run_param&#39;][&#39;WRITE_COV_OUTPUTS&#39;]:</span>
        <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;WRITE_COV_OUTPUTS&#39;</span><span class="p">]:</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cov_filename</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;output_files_prefix&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;cov_</span><span class="si">%d%02d%02d</span><span class="s1">.hdf5&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
            <span class="n">hdfdict</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">cov_data</span><span class="p">,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;output_folder&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cov</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">cov_filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

            <span class="c1"># add attributes</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;output_folder&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cov</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">cov_filename</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdf5_f</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;CONCENTRATION_TYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># loop on tracers</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hdf5_f</span><span class="p">[</span><span class="s2">&quot;IRGA&quot;</span><span class="p">])):</span>
                        <span class="n">hdf5_f</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;covariance function (cov vs lag)&#39;</span><span class="p">;</span> <span class="n">hdf5_f</span><span class="p">[</span><span class="s1">&#39;IRGA&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ppbv ncps-1 m s-1 and lag in samples&#39;</span>
                <span class="k">elif</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;run_param&#39;</span><span class="p">][</span><span class="s1">&#39;CONCENTRATION_TYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># loop on tracers</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hdf5_f</span><span class="p">[</span><span class="s2">&quot;TRACER&quot;</span><span class="p">])):</span>
                        <span class="n">hdf5_f</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;covariance function (cov vs lag)&#39;</span><span class="p">;</span> <span class="n">hdf5_f</span><span class="p">[</span><span class="s1">&#39;TRACER&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)][</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ppbv ncps-1 m s-1 and lag in samples&#39;</span>

        <span class="c1"># save results to file</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;file_creation_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d%02d%02d%02d%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">date</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">res_filename</span> <span class="o">=</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;output_files_prefix&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">%d%02d%02d</span><span class="s1">.hdf5&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">ts</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">date_obj</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H-%M-%S&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">date_obj</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]]</span>
        <span class="n">hdfdict</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;output_folder&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">res_filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="c1"># add attributes &quot;name&quot; and &quot;units&quot;</span>
        <span class="k">if</span>  <span class="s1">&#39;TRACER&#39;</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>  <span class="c1"># TRACER part has been created in the result dict (tracer data for that day)</span>
            <span class="n">add_attributes</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;output_folder&#39;</span><span class="p">],</span> <span class="n">res_filename</span><span class="p">,</span> <span class="n">process_irga_data_day</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;irga&#39;</span><span class="p">][</span><span class="s1">&#39;irga_columns&#39;</span><span class="p">]),</span> <span class="kc">True</span><span class="p">,</span> <span class="n">tracerdata</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">add_attributes</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">][</span><span class="s1">&#39;output_folder&#39;</span><span class="p">],</span> <span class="n">res_filename</span><span class="p">,</span> <span class="n">process_irga_data_day</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ini</span><span class="p">[</span><span class="s1">&#39;irga&#39;</span><span class="p">][</span><span class="s1">&#39;irga_columns&#39;</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">unique_days</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Bernard Heinesch.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>